<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donga Police Raju Mantri - Online Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
        }
        .card {
            transition: transform 0.6s, box-shadow 0.3s;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        @keyframes emoji-float {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            50% { transform: translateY(-40px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-80px) scale(1); opacity: 0; }
        }
        .emoji-reaction {
            position: absolute;
            font-size: 2.5rem;
            animation: emoji-float 2s ease-out forwards;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen">
    <div id="app-container" class="w-full max-w-md mx-auto p-4">

        <!-- Home Screen -->
        <div id="home-screen" class="space-y-6 bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center">
                <h1 class="text-4xl font-bold text-teal-600">Donga Police</h1>
                <p id="auth-status" class="text-gray-500 mt-2">Connecting to server...</p>
            </div>
            <div class="space-y-4">
                 <input type="text" id="name-input" placeholder="Enter Your Name" class="w-full text-center p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none font-semibold text-lg" maxlength="12">
                 <button id="create-game-btn" class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg text-lg btn" disabled>Create New Game</button>
            </div>
            <div class="flex items-center space-x-2">
                <hr class="w-full border-gray-300">
                <span class="text-gray-400 font-semibold">OR</span>
                <hr class="w-full border-gray-300">
            </div>
            <div class="space-y-3">
                <input type="text" id="game-id-input" placeholder="Enter Game ID" class="w-full text-center p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent outline-none uppercase tracking-widest font-semibold">
                <button id="join-game-btn" class="w-full bg-gray-700 text-white font-bold py-3 px-6 rounded-lg text-lg btn" disabled>Join Game</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden text-center space-y-6 bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold">Lobby</h2>
            <p class="text-gray-500">Share this Game ID with your friends:</p>
            <div class="bg-teal-50 p-4 rounded-lg flex items-center justify-center space-x-3">
                <span id="lobby-game-id" class="text-3xl font-bold text-teal-600 tracking-widest"></span>
                <button id="copy-id-btn" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>
                </button>
            </div>
            <div id="player-list" class="space-y-2"></div>
            <p id="lobby-status" class="text-gray-500 animate-pulse">Waiting for 4 players to join...</p>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden w-full max-w-md mx-auto relative">
            <div id="reaction-overlay" class="absolute inset-0 pointer-events-none z-20"></div>
            <div class="bg-white p-4 sm:p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-sm">Room: <span id="game-room-id" class="font-bold text-teal-600"></span></div>
                    <div class="text-sm">Round: <span id="game-round" class="font-bold"></span></div>
                </div>
                
                <div id="status-display" class="text-center bg-gray-100 p-4 rounded-lg mb-4 h-16 flex items-center justify-center">
                    <p id="status-text" class="text-lg font-semibold"></p>
                </div>

                <div id="players-container" class="grid grid-cols-2 gap-4 mb-6"></div>

                <div id="my-chit-container" class="text-center">
                    <p class="mb-2 font-semibold">Your Chit</p>
                    <div id="my-chit-card" class="card w-48 h-24 mx-auto">
                        <div class="card-face w-full h-full p-4 rounded-lg bg-teal-500 text-white flex items-center justify-center shadow"><p class="font-bold text-xl">Your Role</p></div>
                        <div id="my-chit-back" class="card-back w-full h-full p-4 rounded-lg flex flex-col items-center justify-center shadow-lg"></div>
                    </div>
                </div>
                
                <div id="action-container" class="mt-6 text-center space-y-3">
                   <button id="show-roles-btn" class="hidden w-full bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg text-lg btn">Show All Roles</button>
                   <button id="play-again-btn" class="hidden w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-lg text-lg btn">Play Next Round</button>
                </div>
            </div>
             <div id="scores-container" class="mt-4 bg-white p-4 rounded-2xl shadow-lg">
                <h3 class="font-bold text-center mb-2">Scoreboard</h3>
                <div id="scores-list" class="space-y-1"></div>
            </div>
            <div id="emoji-bar" class="mt-4 bg-white p-2 rounded-full shadow-lg flex justify-around items-center">
                <!-- Emojis will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
           apiKey: "AIzaSyCp8UFvV6eOVACbaLq7ylOjEZOBitUMkfc",
           authDomain: "dongapolice-24f1c.firebaseapp.com",
           projectId: "dongapolice-24f1c",
           storageBucket: "dongapolice-24f1c.appspot.com",
           messagingSenderId: "797826379293",
           appId: "1:797826379293:web:92a7231a8891be6527e0f4",
           measurementId: "G-XYBV7DFMHL"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'donga-police-game';
        
        // --- Global State ---
        let db, auth, userId, currentGameId = null, gameUnsubscribe = null;

        // --- HTML Elements ---
        const screens = { home: document.getElementById('home-screen'), lobby: document.getElementById('lobby-screen'), game: document.getElementById('game-screen') };
        const nameInput = document.getElementById('name-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const authStatus = document.getElementById('auth-status');
        const copyIdBtn = document.getElementById('copy-id-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const showRolesBtn = document.getElementById('show-roles-btn');
        const emojiBar = document.getElementById('emoji-bar');

        // --- Initialization ---
        const initializeFirebase = async () => {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIza") === false) {
                authStatus.textContent = "Firebase is not configured.";
                authStatus.classList.add('text-red-500', 'font-semibold');
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        createGameBtn.disabled = false;
                        joinGameBtn.disabled = false;
                        authStatus.textContent = "Ready to play!";
                        authStatus.classList.replace('text-gray-500', 'text-green-600');
                    }
                });
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase connection failed:", error);
                authStatus.textContent = error.code === 'auth/configuration-not-found' ? "Error: Anonymous Auth is not enabled in Firebase." : `Error: ${error.code}`;
                authStatus.classList.add('text-red-500', 'font-semibold');
            }
        };

        const validateName = () => {
            const name = nameInput.value.trim();
            if (!name) {
                alert("Please enter your name.");
                return null;
            }
            return name;
        };
        
        // --- Game Flow ---
        const createGame = async () => {
            const name = validateName();
            if (!name) return;
            currentGameId = Math.random().toString(36).substring(2, 6).toUpperCase();
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameId);
            const newPlayer = { name, score: 0 };
            await setDoc(gameRef, {
                gameId: currentGameId,
                players: { [userId]: newPlayer },
                playerOrder: [userId],
                gameState: 'lobby', // lobby, waiting_for_guess, guess_made, round_over
                round: 0,
                reactions: {},
                createdAt: new Date(),
            });
            subscribeToGame(currentGameId);
        };

        const joinGame = async () => {
            const name = validateName();
            if (!name) return;
            const gameId = gameIdInput.value.trim().toUpperCase();
            if (!gameId) { alert("Please enter a Game ID."); return; }
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) { alert("Game not found."); return; }
            const gameData = gameSnap.data();
            if (Object.keys(gameData.players).length >= 4 && !gameData.players[userId]) { alert("This game room is full."); return; }
            if (!gameData.players[userId]) {
                const newPlayer = { name, score: 0 };
                const newPlayers = { ...gameData.players, [userId]: newPlayer };
                const newPlayerOrder = [...gameData.playerOrder, userId];
                await updateDoc(gameRef, { players: newPlayers, playerOrder: newPlayerOrder });
            }
            currentGameId = gameId;
            subscribeToGame(gameId);
        };
        
        const subscribeToGame = (gameId) => {
            if (gameUnsubscribe) gameUnsubscribe();
            showScreen('lobby');
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            gameUnsubscribe = onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) { resetGame(); return; }
                const gameData = doc.data();
                updateUI(gameData);
                if (gameData.gameState === 'lobby' && gameData.playerOrder.length === 4 && gameData.playerOrder[0] === userId) {
                    startGame(gameData);
                }
            }, (error) => {
                console.error("Firestore subscription error:", error);
                alert("Connection lost. Check Firestore rules.");
            });
        };

        const startGame = async (gameData) => {
            const roles = ['Raju', 'Mantri', 'Donga', 'Police'];
            const shuffledRoles = roles.sort(() => 0.5 - Math.random());
            const updatedPlayers = { ...gameData.players };
            let policeId, dongaId;
            gameData.playerOrder.forEach((pid, i) => {
                updatedPlayers[pid].role = shuffledRoles[i];
                if (shuffledRoles[i] === 'Police') policeId = pid;
                if (shuffledRoles[i] === 'Donga') dongaId = pid;
            });
            await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, currentGameId), {
                players: updatedPlayers,
                gameState: 'waiting_for_guess',
                round: gameData.round + 1,
                policeId, dongaId, guessResult: null
            });
        };

        const makeGuess = async (guessedPlayerId) => {
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, currentGameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            const gameData = gameSnap.data();
            const isCorrect = guessedPlayerId === gameData.dongaId;
            const updatedPlayers = { ...gameData.players };
            const points = { 'Raju': 1000, 'Mantri': 800, 'Police': 500, 'Donga': 0 };
            const roundScores = {};
            if (isCorrect) {
                gameData.playerOrder.forEach(pid => { roundScores[pid] = points[gameData.players[pid].role]; });
            } else {
                const wronglyAccusedRole = gameData.players[guessedPlayerId].role;
                gameData.playerOrder.forEach(pid => {
                    if (pid === gameData.policeId || pid === guessedPlayerId) roundScores[pid] = 0;
                    else if (pid === gameData.dongaId) roundScores[pid] = points[wronglyAccusedRole];
                    else roundScores[pid] = points[gameData.players[pid].role];
                });
            }
            for (const pid in roundScores) {
                if (updatedPlayers[pid]) updatedPlayers[pid].score += roundScores[pid];
            }
            await updateDoc(gameRef, {
                gameState: 'guess_made',
                guessResult: { isCorrect, roundScores },
                players: updatedPlayers
            });
        };
        
        const showRoles = async () => await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, currentGameId), { gameState: 'round_over' });
        const playAgain = async () => {
            const gameSnap = await getDoc(doc(db, `artifacts/${appId}/public/data/games`, currentGameId));
            if(gameSnap.exists()) startGame(gameSnap.data());
        }

        // --- UI Updates ---
        const updateUI = (gameData) => {
            if (gameData.gameState === 'lobby') {
                document.getElementById('lobby-game-id').textContent = gameData.gameId;
                const playerList = document.getElementById('player-list');
                playerList.innerHTML = '';
                gameData.playerOrder.forEach((pid, i) => {
                    playerList.innerHTML += `<div class="bg-gray-100 p-3 rounded-lg text-left flex items-center space-x-3"><span class="font-mono text-gray-400">${i+1}.</span><span class="font-semibold">${gameData.players[pid].name} ${pid === userId ? '(You)' : ''}</span></div>`;
                });
                document.getElementById('lobby-status').textContent = gameData.playerOrder.length === 4 ? 'Starting game...' : `Waiting for ${4-gameData.playerOrder.length} more players...`;
            } else {
                showScreen('game');
                renderGameScreen(gameData);
                handleReactions(gameData);
            }
        };

        const renderGameScreen = (gameData) => {
            const me = gameData.players[userId];
            if (!me) return;
            const { gameState, guessResult, players, playerOrder, policeId, round } = gameData;
            const isPolice = me.role === 'Police';
            const isHost = playerOrder[0] === userId;

            document.getElementById('game-room-id').textContent = gameData.gameId;
            document.getElementById('game-round').textContent = round;
            
            // My Chit
            const myChitCard = document.getElementById('my-chit-card');
            const myChitBack = document.getElementById('my-chit-back');
            const roleEmojis = { 'Raju': '👑', 'Mantri': '👸', 'Donga': '👺', 'Police': '👮‍♂️' };
            const roleColors = { 'Raju': 'bg-amber-400', 'Mantri': 'bg-fuchsia-400', 'Donga': 'bg-rose-500', 'Police': 'bg-sky-500' };
            myChitBack.innerHTML = `<span class="text-4xl">${roleEmojis[me.role]}</span><p class="font-bold text-xl mt-1">${me.role}</p>`;
            myChitBack.className = `card-back w-full h-full p-4 rounded-lg flex flex-col items-center justify-center shadow-lg text-white ${roleColors[me.role]}`;
            myChitCard.classList.add('is-flipped');

            // Player Cards
            const playersContainer = document.getElementById('players-container');
            playersContainer.innerHTML = '';
            playerOrder.filter(pid => pid !== userId).forEach(pid => {
                const canGuess = isPolice && gameState === 'waiting_for_guess';
                const cardIsFlipped = gameState === 'round_over';
                playersContainer.innerHTML += `
                    <div id="player-card-${pid}" class="card ${cardIsFlipped ? 'is-flipped' : ''} ${canGuess ? 'cursor-pointer hover:shadow-xl' : 'cursor-default'}" ${canGuess ? `onclick="window.makeGuess('${pid}')"` : ''}>
                        <div class="card-face w-full h-28 p-4 rounded-lg bg-white flex flex-col items-center justify-center shadow"><p class="font-bold text-lg">${players[pid].name}</p>${canGuess ? '<p class="text-sm text-teal-500 font-semibold mt-1">Guess?</p>' : ''}</div>
                        <div class="card-back w-full h-28 p-4 rounded-lg flex flex-col items-center justify-center shadow-lg text-white ${roleColors[players[pid].role]}"><span class="text-4xl">${roleEmojis[players[pid].role]}</span><p class="font-bold text-lg mt-1">${players[pid].role}</p></div>
                    </div>`;
            });

            // Status Text and Action Buttons
            const statusText = document.getElementById('status-text');
            showRolesBtn.classList.add('hidden');
            playAgainBtn.classList.add('hidden');
            if (gameState === 'waiting_for_guess') statusText.textContent = isPolice ? 'Guess who is the Donga!' : `Waiting for Police (${players[policeId].name}) to guess...`;
            else if (gameState === 'guess_made') {
                statusText.innerHTML = guessResult.isCorrect ? `✅ Correct Guess!` : `❌ Wrong Guess!`;
                showRolesBtn.classList.remove('hidden');
            } else if (gameState === 'round_over') {
                const scoreGained = guessResult.roundScores[userId];
                statusText.innerHTML = guessResult.isCorrect ? `The Donga was caught! <span class="font-normal">(You got ${scoreGained} pts)</span>` : `The Donga escaped! <span class="font-normal">(You got ${scoreGained} pts)</span>`;
                if (isHost) playAgainBtn.classList.remove('hidden');
            }

            // Scoreboard
            const scoresList = document.getElementById('scores-list');
            scoresList.innerHTML = '';
            playerOrder.sort((a, b) => players[b].score - players[a].score).forEach(pid => {
                scoresList.innerHTML += `<div class="flex justify-between items-center text-sm p-2 rounded-md ${pid === userId ? 'bg-teal-50' : ''}"><span class="font-semibold">${players[pid].name} ${pid === userId ? '(You)' : ''}</span><span class="font-bold text-teal-600">${players[pid].score} pts</span></div>`;
            });
        };
        
        // --- Reactions ---
        const emojis = ['👍', '😂', '🤔', '👎', '🎉', '🤯'];
        emojiBar.innerHTML = emojis.map(e => `<button class="text-2xl p-2 rounded-full hover:bg-gray-200 transition-colors">${e}</button>`).join('');
        emojiBar.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') sendReaction(e.target.textContent);
        });

        const sendReaction = async (emoji) => {
            await updateDoc(doc(db, `artifacts/${appId}/public/data/games`, currentGameId), {
                [`reactions.${userId}`]: { emoji, timestamp: Date.now() }
            });
        };

        let lastReactionTime = {};
        const handleReactions = (gameData) => {
            const reactionOverlay = document.getElementById('reaction-overlay');
            for (const pid in gameData.reactions) {
                if (!lastReactionTime[pid] || lastReactionTime[pid] < gameData.reactions[pid].timestamp) {
                    lastReactionTime[pid] = gameData.reactions[pid].timestamp;
                    const reactionEl = document.createElement('div');
                    reactionEl.className = 'emoji-reaction';
                    reactionEl.textContent = gameData.reactions[pid].emoji;
                    // Position randomly at the bottom
                    reactionEl.style.left = `${Math.random() * 80 + 10}%`;
                    reactionOverlay.appendChild(reactionEl);
                    setTimeout(() => reactionEl.remove(), 2000);
                }
            }
        };
        
        const resetGame = () => {
             if (gameUnsubscribe) gameUnsubscribe();
             Object.assign(window, { currentGameId: null, gameUnsubscribe: null });
             gameIdInput.value = '';
             showScreen('home');
        };

        // --- Event Listeners ---
        window.onload = initializeFirebase;
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', joinGame);
        showRolesBtn.addEventListener('click', showRoles);
        playAgainBtn.addEventListener('click', playAgain);
        copyIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('lobby-game-id').textContent).then(() => {
                copyIdBtn.innerHTML = 'Copied!';
                setTimeout(() => { copyIdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>`; }, 1500);
            });
        });
        window.makeGuess = makeGuess; // Expose for inline onclick

    </script>
</body>
</html>
