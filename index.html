<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Donga Police: Raja Rani Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Polyfill for process error in browser environment
        window.process = { env: { NODE_ENV: 'development' } };
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --bg-dark: #111827; --bg-light: #f0f9ff;
            --text-dark: #e5e7eb; --text-light: #1f2937;
            --surface-dark: #1f2937; --surface-light: #ffffff;
            --primary: #3b82f6;
        }
        html.dark {
            --bg-main: var(--bg-dark); --text-main: var(--text-dark); --surface-main: var(--surface-dark);
        }
        html:not(.dark) {
            --bg-main: var(--bg-light); --text-main: var(--text-light); --surface-main: var(--surface-light);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-main); color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        .chit-scene { perspective: 1000px; }
        .chit { transform-style: preserve-3d; transition: transform 0.8s; }
        .chit.is-flipped { transform: rotateY(180deg); }
        .chit-face { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .confetti { position: absolute; animation-timing-function: linear; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="audio-container"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useCallback, useRef } = React;

        // --- Helper Components & Hooks ---
        const playSound = (() => {
            let sounds;
            return (sound, note = 'C4', duration = '8n') => {
                if (!sounds) {
                    sounds = {
                        flip: new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination(),
                        click: new Tone.PolySynth(Tone.Synth).toDestination(),
                        win: new Tone.Synth({ oscillator: { type: 'triangle8' } }).toDestination(),
                        lose: new Tone.Synth({ oscillator: { type: 'sawtooth' } }).toDestination(),
                        message: new Tone.MembraneSynth().toDestination(),
                    };
                }
                if (Tone.context.state === 'running') sounds[sound].triggerAttackRelease(note, duration);
            };
        })();

        const Confetti = ({ show }) => {
            if (!show) return null;
            const confettiPieces = Array.from({ length: 50 }, (_, i) => {
                const style = {
                    left: `${Math.random() * 100}%`,
                    top: `${-20}%`,
                    fontSize: `${1 + Math.random() * 1.5}rem`,
                    animation: `fall ${2 + Math.random() * 2}s linear ${Math.random() * 2}s forwards`
                };
                return <div key={i} className="confetti" style={style}>{['ğŸ‰', 'ğŸŠ', 'âœ¨', 'ğŸ†'][i % 4]}</div>;
            });

            return <div className="absolute inset-0 pointer-events-none">{confettiPieces}</div>;
        };
        const style = document.createElement('style');
        style.textContent = `@keyframes fall { to { top: 120%; transform: rotate(${Math.random() * 720}deg); } }`;
        document.head.append(style);
        
        // --- Main App Component ---
        function App() {
            const [gameState, setGameState] = useState('home');
            const [gameData, setGameData] = useState(null);
            const [userId, setUserId] = useState(null);
            const [username, setUsername] = useState('');
            const [roomCode, setRoomCode] = useState('');
            const [isMuted, setIsMuted] = useState(false);
            const [isDarkMode, setIsDarkMode] = useState(true);
            
            // WebRTC refs
            const localStreamRef = useRef();
            const peerConnectionsRef = useRef(new Map());
            
            const dbRef = useRef();
            const authRef = useRef();

            const appId = 'donga-police-game';
            const getGameRef = (code) => doc(dbRef.current, `artifacts/${appId}/public/data/games`, code);
            
            useEffect(() => {
                const initialize = async () => {
                    const firebaseConfig = {
                        apiKey: "AIzaSyCp8UFvV6eOVACbaLq7ylOjEZOBitUMkfc",
                        authDomain: "dongapolice-24f1c.firebaseapp.com",
                        projectId: "dongapolice-24f1c",
                        storageBucket: "dongapolice-24f1c.appspot.com",
                        messagingSenderId: "797826379293",
                        appId: "1:797826379293:web:92a7231a8891be6527e0f4"
                    };
                    const app = initializeApp(firebaseConfig);
                    dbRef.current = getFirestore(app);
                    authRef.current = getAuth(app);
                    await signInAnonymously(authRef.current);
                    onAuthStateChanged(authRef.current, user => {
                        if (user) setUserId(user.uid);
                    });
                };
                initialize();
                document.documentElement.classList.toggle('dark', isDarkMode);
            }, []);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', isDarkMode);
            }, [isDarkMode]);

            const subscribeToGame = useCallback((code) => {
                const gameRef = getGameRef(code);
                return onSnapshot(gameRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setGameData(data);
                        setGameState(data.gameState);
                    } else {
                        alert("Game room closed.");
                        setGameState('home');
                        setGameData(null);
                    }
                });
            }, []);

            const createRoom = async () => {
                if (!username.trim()) { alert("Please enter your name!"); return; }
                const newRoomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
                const gameRef = getGameRef(newRoomCode);
                await setDoc(gameRef, {
                    hostId: userId,
                    players: { [userId]: { name: username, score: 0 } },
                    chat: [],
                    gameState: 'lobby',
                    roomCode: newRoomCode,
                });
                const unsubscribe = subscribeToGame(newRoomCode);
                return () => unsubscribe();
            };

            const joinRoom = async () => {
                if (!username.trim()) { alert("Please enter your name!"); return; }
                if (!roomCode.trim()) { alert("Please enter a room code."); return; }
                const gameRef = getGameRef(roomCode);
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) { alert("Room not found!"); return; }
                await updateDoc(gameRef, { [`players.${userId}`]: { name: username, score: 0 } });
                const unsubscribe = subscribeToGame(roomCode);
                return () => unsubscribe();
            };
            
            const renderContent = () => {
                switch (gameState) {
                    case 'lobby': return <LobbyScreen gameData={gameData} userId={userId} getGameRef={getGameRef} />;
                    case 'reveal': return <RevealScreen gameData={gameData} userId={userId} getGameRef={getGameRef} />;
                    case 'guess': return <GuessScreen gameData={gameData} userId={userId} getGameRef={getGameRef} />;
                    case 'result': return <ResultScreen gameData={gameData} userId={userId} getGameRef={getGameRef} />;
                    default: return <HomeScreen setUsername={setUsername} setRoomCode={setRoomCode} createRoom={createRoom} joinRoom={joinRoom} />;
                }
            };

            return (
                <div className="w-screen h-screen flex justify-center items-center">
                    <div id="dark-mode-toggle" onClick={() => setIsDarkMode(!isDarkMode)}>{isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'}</div>
                    {renderContent()}
                    {gameState !== 'home' && <Chat gameData={gameData} username={username} getGameRef={getGameRef} />}
                </div>
            );
        }

        const HomeScreen = ({ setUsername, setRoomCode, createRoom, joinRoom }) => {
            const handleAction = async (action) => {
                await Tone.start();
                playSound('click');
                action();
            }
            return (
                 <div className="w-full max-w-md bg-[var(--surface-main)] p-8 rounded-2xl shadow-xl space-y-6">
                    <h1 className="text-4xl font-bold text-[var(--primary)]">Donga Police</h1>
                    <p className="text-xl font-semibold -mt-4">Raja Rani Edition</p>
                    <input onChange={e => setUsername(e.target.value)} type="text" className="input-field text-center" placeholder="Enter Your Name" />
                    <div className="space-y-3">
                        <button onClick={() => handleAction(createRoom)} className="btn btn-primary w-full">Create Room ğŸ‘‘</button>
                        <div className="flex items-center gap-3">
                            <input onChange={e => setRoomCode(e.target.value.toUpperCase())} type="text" className="input-field uppercase" placeholder="Room Code" />
                            <button onClick={() => handleAction(joinRoom)} className="btn btn-secondary">Join</button>
                        </div>
                    </div>
                    <p className="text-xs text-center text-gray-500 pt-4">A game by Krishnakanth</p>
                </div>
            );
        }
        
        const LobbyScreen = ({ gameData, userId, getGameRef }) => {
            const isHost = gameData.hostId === userId;
            const canStart = Object.keys(gameData.players).length >= 4;

            const startGame = async () => {
                playSound('click');
                let { players } = gameData;
                const playerIds = Object.keys(players);
                let baseRoles = ['ğŸ‘® Police', 'ğŸ•µï¸â€â™‚ï¸ Donga', 'ğŸ‘‘ Raja', 'ğŸ‘¸ Rani'];
                while (baseRoles.length < playerIds.length) baseRoles.push('ğŸ§â€â™‚ï¸ Public');
                const shuffledRoles = baseRoles.sort(() => Math.random() - 0.5);
                const roles = {};
                playerIds.forEach((id, i) => roles[id] = shuffledRoles[i]);
                Object.keys(players).forEach(uid => players[uid].revealed = false);
                await updateDoc(getGameRef(gameData.roomCode), { gameState: 'reveal', roles, players });
            };

            return (
                <div className="w-full max-w-md bg-[var(--surface-main)] p-8 rounded-2xl shadow-xl">
                    <h2 className="text-3xl font-bold mb-2">Lobby</h2>
                    <p>Room Code: <strong className="text-2xl text-[var(--primary)] tracking-widest">{gameData.roomCode}</strong></p>
                    <div className="space-y-2 my-6 min-h-[150px] bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                        {Object.values(gameData.players).map(p => <div key={p.name} className="bg-gray-200 dark:bg-gray-700 p-3 rounded-lg font-semibold">{p.name}</div>)}
                    </div>
                    {isHost && <button onClick={startGame} disabled={!canStart} className="btn btn-primary w-full text-xl">Start Game ğŸ”¥</button>}
                    {!isHost && <p>Waiting for host to start...</p>}
                    {!canStart && <p className="text-sm text-gray-500 mt-2">Need at least 4 players to start.</p>}
                </div>
            );
        };
        
        const RevealScreen = ({ gameData, userId, getGameRef }) => {
            const myPlayer = gameData.players[userId];
            const myRole = gameData.roles[userId];
            const [emoji, name] = myRole.split(' ');

            const handleReveal = async () => {
                if(myPlayer.revealed) return;
                await Tone.start();
                playSound('flip');
                await updateDoc(getGameRef(gameData.roomCode), { [`players.${userId}.revealed`]: true });
            };

            return (
                <div className="flex flex-col items-center">
                    <h2 className="text-3xl font-bold mb-2">Your Secret Role Is...</h2>
                    <p className="mb-6">Don't show anyone! ğŸ¤«</p>
                    <div className="chit-scene" onClick={handleReveal}>
                        <div className={`chit ${myPlayer.revealed ? 'is-flipped' : ''}`}>
                            <div className="chit-face chit-front flex flex-col justify-center items-center"><div className="text-3xl">ğŸ´</div><div className="font-bold text-xl mt-2">Click to Reveal</div></div>
                            <div className="chit-face chit-back flex flex-col justify-center items-center"><div className="text-7xl">{emoji}</div><div className="text-3xl font-bold mt-2">{name}</div></div>
                        </div>
                    </div>
                    {myPlayer.revealed && <p className="text-lg mt-8 opacity-100 transition-opacity">Waiting for others to see their roles...</p>}
                </div>
            );
        };

        const GuessScreen = ({ gameData, userId, getGameRef }) => {
            const policeId = Object.keys(gameData.roles).find(id => gameData.roles[id] === 'ğŸ‘® Police');
            const isPolice = userId === policeId;

            const makeGuess = async (guessedId) => {
                playSound('click');
                const { roles, players } = gameData;
                const dongaId = Object.keys(roles).find(id => roles[id] === 'ğŸ•µï¸â€â™‚ï¸ Donga');
                const policeWon = guessedId === dongaId;

                const pointsMap = { 'ğŸ‘‘ Raja': 1000, 'ğŸ‘¸ Rani': 800, 'ğŸ‘® Police': 500, 'ğŸ•µï¸â€â™‚ï¸ Donga': 0, 'ğŸ§â€â™‚ï¸ Public': 100 };
                const updatedPlayers = { ...players };

                if (policeWon) {
                    playSound('win');
                    Object.keys(roles).forEach(uid => {
                        if (roles[uid] !== 'ğŸ•µï¸â€â™‚ï¸ Donga') updatedPlayers[uid].score += pointsMap[roles[uid]] || 0;
                    });
                } else {
                    playSound('lose');
                    Object.keys(roles).forEach(uid => {
                        if (uid !== policeId && roles[uid] !== 'ğŸ•µï¸â€â™‚ï¸ Donga') updatedPlayers[uid].score += pointsMap[roles[uid]] || 0;
                    });
                }
                
                const result = {
                    winner: policeWon ? "Police Wins! ğŸ‰" : "Donga Wins! ï¿½",
                    dialogue: policeWon ? "Donga dorikesadu ra babu! ğŸ˜†" : "Mee guess wrong! ğŸ˜‚ Donga gelichadu!",
                };
                
                await updateDoc(getGameRef(gameData.roomCode), { gameState: 'result', result, players: updatedPlayers });
            };

            return (
                 <div className="text-center w-full max-w-md">
                    <h2 className="text-3xl font-bold">{isPolice ? "Your turn to guess!" : `Waiting for ${gameData.players[policeId].name} (Police)...`}</h2>
                    <p className="text-lg italic bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 p-3 rounded-lg my-4">Nuve donga ra! Naku telusu ğŸ¤¨</p>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {isPolice && Object.entries(gameData.players).map(([uid, player]) => {
                            if (uid !== policeId) return <button key={uid} onClick={() => makeGuess(uid)} className="btn btn-secondary">{player.name}</button>;
                            return null;
                        })}
                    </div>
                </div>
            );
        };
        
        const ResultScreen = ({ gameData, userId, getGameRef }) => {
            const isHost = gameData.hostId === userId;
            const { winner, dialogue } = gameData.result;

            const playAgain = async () => {
                playSound('click');
                await startGameFlow();
            };
            
            const startGameFlow = async () => {
                let { players } = gameData;
                const playerIds = Object.keys(players);
                
                let baseRoles = ['ğŸ‘® Police', 'ğŸ•µï¸â€â™‚ï¸ Donga', 'ğŸ‘‘ Raja', 'ğŸ‘¸ Rani'];
                while (baseRoles.length < playerIds.length) baseRoles.push('ğŸ§â€â™‚ï¸ Public');
                
                const shuffledRoles = baseRoles.sort(() => Math.random() - 0.5);
                const roles = {};
                playerIds.forEach((id, i) => roles[id] = shuffledRoles[i]);
                Object.keys(players).forEach(uid => players[uid].revealed = false);

                await updateDoc(getGameRef(gameData.roomCode), { gameState: 'reveal', roles, players, result: null });
            };

            return (
                <div className="w-full max-w-lg bg-[var(--surface-main)] p-8 rounded-2xl shadow-xl text-center relative overflow-hidden">
                    <Confetti show={winner.includes('Wins')} />
                    <h2 className="text-4xl font-bold mb-4">{winner}</h2>
                    <p className="text-xl mb-6 font-semibold">{dialogue}</p>
                    <div className="grid grid-cols-2 gap-4 my-4">
                        <div className="space-y-2 text-left bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                            <h3 className="font-bold mb-2">Roles</h3>
                            {Object.keys(gameData.roles).map(uid => <p key={uid}>{gameData.players[uid].name}: {gameData.roles[uid]}</p>)}
                        </div>
                        <div className="space-y-2 text-left bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                            <h3 className="font-bold mb-2">Scoreboard ğŸ†</h3>
                            {Object.values(gameData.players).sort((a,b) => b.score - a.score).map(p => <p key={p.name}>{p.name}: {p.score} points</p>)}
                        </div>
                    </div>
                    {isHost && <button onClick={playAgain} className="btn btn-primary w-full mt-4">Play Next Round ğŸ”</button>}
                    {!isHost && <p>Waiting for host to start a new game...</p>}
                </div>
            );
        };

        const Chat = ({ gameData, username, getGameRef }) => {
            const [chatInput, setChatInput] = useState('');
            const [isOpen, setIsOpen] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [gameData.chat]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!chatInput.trim()) return;
                playSound('message');
                await updateDoc(getGameRef(gameData.roomCode), { chat: arrayUnion({ name: username, text: chatInput }) });
                setChatInput('');
            };

            return (
                 <div id="chat-container">
                    <div id="chat-window" style={{ display: isOpen ? 'flex' : 'none' }}>
                        <div id="chat-messages">
                            {gameData.chat?.map((msg, i) => <div key={i} className="message"><strong>{msg.name}:</strong> {msg.text}</div>)}
                            <div ref={messagesEndRef} />
                        </div>
                        <form onSubmit={handleSubmit} id="chat-form" className="flex p-2 border-t border-gray-300 dark:border-gray-600">
                            <input value={chatInput} onChange={e => setChatInput(e.target.value)} id="chat-input" className="input-field !rounded-r-none" placeholder="Say something..." autoComplete="off" />
                            <button type="submit" className="btn btn-primary !rounded-l-none">Send</button>
                        </form>
                    </div>
                    <div id="chat-toggle" onClick={() => setIsOpen(!isOpen)}>{isOpen ? 'ğŸ”½' : 'ğŸ—¨ï¸'}</div>
                </div>
            )
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
ï¿½
