<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Werewolf: A Game of Deception</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Mock process env for React dev tools
        window.process = { env: { NODE_ENV: 'development' } };
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --bg-dark: #1f2937; --bg-light: #f3f4f6;
            --text-dark: #f9fafb; --text-light: #111827;
            --surface-dark: #374151; --surface-light: #ffffff;
            --primary: #c026d3;
            --secondary: #10b981;
            --accent: #f59e0b;
            --danger: #ef4444;
        }
        html.dark { --bg-main: var(--bg-dark); --text-main: var(--text-dark); --surface-main: var(--surface-dark); }
        html:not(.dark) { --bg-main: var(--bg-light); --text-main: var(--text-light); --surface-main: var(--surface-light); }
        body { font-family: 'Inter', 'Noto Sans Telugu', system-ui, -apple-system, sans-serif; background-color: var(--bg-main); color: var(--text-main); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow: hidden; }
        .btn { padding: 0.75rem 1.75rem; font-size: 1rem; font-weight: 600; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .input-field { width: 100%; padding: 0.75rem; border: 2px solid #4b5563; background-color: #374151; color: white; border-radius: 0.75rem; transition: all 0.2s; }
        html:not(.dark) .input-field { border: 2px solid #d1d5db; background-color: #f3f4f6; color: #1f2937;}
        .input-field:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(192, 38, 211, 0.3); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-in forwards; }

        .night-phase { background: #111827; }
        .day-phase { background: #dbeafe; }
        html.dark .day-phase { background: #1e3a8a; }

        .role-werewolf { color: #ef4444; }
        .role-villager { color: #22c55e; }
        .role-seer { color: #3b82f6; }
        .role-doctor { color: #ec4899; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Telugu:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, writeBatch, deleteField, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const { useState, useEffect, useCallback, useRef } = React;

        const translations = {
            en: {
                title: "Werewolf",
                subtitle: "A game of deception & survival",
                enterName: "Enter Your Name",
                createRoom: "Create New Game 🐺",
                join: "Join",
                roomCode: "Room Code",
                lobbyTitle: "Lobby",
                playersJoined: (count) => `Players Joined (${count}):`,
                host: "Host",
                startGame: "Start Game",
                needPlayers: (needed) => `Need at least ${needed} players`,
                night: "Night",
                day: "Day",
                dayNum: (day) => `Day ${day}`,
                players: "Players",
                eliminated: "Eliminated",
                alive: "Alive",
                vote: "Vote",
                yourRole: "Your Role",
                werewolf_role: "🐺 Werewolf",
                seer_role: "👁️ Seer",
                doctor_role: "🧑‍⚕️ Doctor",
                villager_role: "🧑‍🌾 Villager",
                werewolf_action: "Who do you want to eliminate?",
                seer_action: "Whose role do you want to see?",
                doctor_action: "Who do you want to save?",
                villager_action: "You sleep peacefully through the night.",
                seer_result: (name, role) => `You see that ${name} is a ${role}.`,
                connecting: "Connecting...",
                error_name: "Please enter a name.",
                error_code: "Please enter a room code.",
                error_not_found: "Room not found!",
                error_connect_failed: "Could not connect to game services."
            },
            te: {
                title: "తోడేలు ఆట",
                subtitle: "మోసం మరియు మనుగడ యొక్క ఆట",
                enterName: "మీ పేరు నమోదు చేయండి",
                createRoom: "కొత్త ఆట సృష్టించండి 🐺",
                join: "చేరండి",
                roomCode: "గది కోడ్",
                lobbyTitle: "లాబీ",
                playersJoined: (count) => `ఆటగాళ్ళు చేరారు (${count}):`,
                host: "యజమాని",
                startGame: "ఆట ప్రారంభించండి",
                needPlayers: (needed) => `కనీసం ${needed} మంది ఆటగాళ్లు కావాలి`,
                night: "రాత్రి",
                day: "పగలు",
                dayNum: (day) => `రోజు ${day}`,
                players: "ఆటగాళ్ళు",
                eliminated: "తొలగించబడ్డారు",
                alive: "జీవించి ఉన్నారు",
                vote: "ఓటు వేయండి",
                yourRole: "మీ పాత్ర",
                werewolf_role: "🐺 తోడేలు",
                seer_role: "👁️ జ్యోతిష్యుడు",
                doctor_role: "�‍⚕️ వైద్యుడు",
                villager_role: "🧑‍🌾 గ్రామస్థుడు",
                werewolf_action: "మీరు ఎవరిని తొలగించాలనుకుంటున్నారు?",
                seer_action: "మీరు ఎవరి పాత్రను చూడాలనుకుంటున్నారు?",
                doctor_action: "మీరు ఎవరిని కాపాడాలనుకుంటున్నారు?",
                villager_action: "మీరు రాత్రి ప్రశాంతంగా నిద్రపోతారు.",
                seer_result: (name, role) => `మీరు చూసిన ప్రకారం ${name} ఒక ${role}.`,
                connecting: "కనెక్ట్ అవుతోంది...",
                error_name: "దయచేసి పేరు నమోదు చేయండి.",
                error_code: "దయచేసి గది కోడ్ నమోదు చేయండి.",
                error_not_found: "గది కనుగొనబడలేదు!",
                error_connect_failed: "గేమ్ సేవలకు కనెక్ట్ కాలేకపోయింది."
            }
        };

        function assignWerewolfRoles(playerIds, t) {
            const playerCount = playerIds.length;
            let rolesToAssign = [];
            
            // Basic roles from translation
            const baseRoles = {
                werewolf: t('werewolf_role'),
                seer: t('seer_role'),
                doctor: t('doctor_role'),
                villager: t('villager_role')
            };

            let werewolfCount = Math.floor(playerCount / 4);
            if (werewolfCount === 0) werewolfCount = 1;

            rolesToAssign.push(...Array(werewolfCount).fill(baseRoles.werewolf));
            if (playerCount > 3) rolesToAssign.push(baseRoles.seer);
            if (playerCount > 4) rolesToAssign.push(baseRoles.doctor);

            const villagerCount = playerCount - rolesToAssign.length;
            rolesToAssign.push(...Array(villagerCount).fill(baseRoles.villager));

            const shuffledRoles = rolesToAssign.sort(() => Math.random() - 0.5);
            
            const finalRoles = {};
            playerIds.forEach((id, index) => {
                finalRoles[id] = shuffledRoles[index];
            });
            return finalRoles;
        }
        
        const HomeScreen = ({ setUsername, createRoom, joinRoom, error, t, setLanguage }) => {
            const [roomCodeInput, setRoomCodeInput] = useState('');

            return (
                <div className="w-full max-w-md bg-[var(--surface-main)] p-8 rounded-2xl shadow-xl space-y-6 fade-in">
                    <h1 className="text-4xl font-bold text-center text-[var(--primary)]">{t('title')}</h1>
                    <p className="text-center text-lg">{t('subtitle')}</p>
                    
                    {error && <p className="text-red-500 text-center font-semibold">{error}</p>}
                    
                    <input onChange={e => setUsername(e.target.value)} type="text" className="input-field text-center" placeholder={t('enterName')} />
                    
                    <div className="space-y-3">
                        <button onClick={createRoom} className="btn bg-[var(--primary)] text-white w-full">{t('createRoom')}</button>
                        <div className="flex items-center gap-3">
                            <input value={roomCodeInput} onChange={e => setRoomCodeInput(e.target.value.toUpperCase())} type="text" className="input-field uppercase flex-grow" placeholder={t('roomCode')} />
                            <button onClick={() => joinRoom(roomCodeInput)} className="btn bg-gray-600 text-white">{t('join')}</button>
                        </div>
                    </div>
                     <div className="text-center">
                        <select onChange={(e) => setLanguage(e.target.value)} defaultValue="te" className="input-field">
                            <option value="en">English</option>
                            <option value="te">తెలుగు</option>
                        </select>
                    </div>
                </div>
            );
        };
        
        const LobbyScreen = ({ gameData, userId, getGameRef, t }) => {
            const { hostId, players, roomCode } = gameData;
            const isHost = hostId === userId;
            const canStart = Object.keys(players).length >= 4;

            const startGame = async () => {
                const playerIds = Object.keys(players);
                const newRoles = assignWerewolfRoles(playerIds, t);
                await updateDoc(getGameRef(roomCode), { 
                    gameState: 'night', 
                    roles: newRoles,
                    turn: 'night',
                    day: 1,
                    votes: {},
                    werewolfAction: {},
                    seerAction: null,
                    doctorAction: null,
                    eliminated: {}
                });
            };

            return (
                <div className="w-full max-w-md bg-[var(--surface-main)] p-8 rounded-2xl shadow-xl fade-in">
                    <h2 className="text-3xl font-bold">{t('lobbyTitle')}</h2>
                    <div className="text-lg my-2">{t('roomCode')}: <span className="font-bold text-[var(--primary)] tracking-widest">{roomCode}</span></div>
                    <div className="space-y-2 my-6 min-h-[150px] bg-gray-200 dark:bg-gray-800 p-4 rounded-lg">
                        <h3 className="font-bold text-lg mb-2">{t('playersJoined', Object.keys(players).length)}</h3>
                        {Object.values(players).map(p => (
                            <div key={p.uid} className="bg-gray-300 dark:bg-gray-700 p-3 rounded-lg font-semibold flex items-center justify-between">
                                {p.name} {p.uid === hostId && '👑'}
                            </div>
                        ))}
                    </div>
                    {isHost ? (
                        <button onClick={startGame} disabled={!canStart} className="btn bg-[var(--primary)] text-white w-full">
                            {canStart ? t('startGame') : t('needPlayers', 4)}
                        </button>
                    ) : <p>{t('waitingForHost')}</p>}
                </div>
            );
        };
        
        function GameScreen({ gameData, userId, getGameRef, t }) {
            const { players, roles, turn, eliminated, votes, day } = gameData;
            const myRole = roles[userId];
            const isAlive = !eliminated || !eliminated[userId];

            const handleVote = async (targetId) => {
                if (!isAlive || turn !== 'day') return;
                await updateDoc(getGameRef(gameData.roomCode), {
                    [`votes.${userId}`]: targetId
                });
            };

            const alivePlayers = Object.keys(players).filter(pId => !eliminated || !eliminated[pId]);

            return (
                <div className={`w-full h-full p-4 md:p-8 flex flex-col items-center justify-center transition-colors duration-1000 ${turn === 'night' ? 'night-phase' : 'day-phase'}`}>
                    <div className="text-center mb-6">
                        <h1 className="text-4xl font-bold">{turn === 'night' ? t('night') : t('day')} 🌙</h1>
                        <p>{t('dayNum', day)}</p>
                    </div>

                    <div className="w-full max-w-4xl bg-[var(--surface-main)] p-6 rounded-2xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-4">{t('players')}</h2>
                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {Object.entries(players).map(([pId, player]) => {
                                const isPlayerEliminated = eliminated && eliminated[pId];
                                const voteCount = votes ? Object.values(votes).filter(v => v === pId).length : 0;
                                return (
                                    <div key={pId} className={`p-4 rounded-lg text-center ${isPlayerEliminated ? 'bg-red-900/50 opacity-50' : 'bg-gray-200 dark:bg-gray-700'}`}>
                                        <p className="font-bold text-lg">{player.name}</p>
                                        {isPlayerEliminated ? <p className="text-sm">{t('eliminated')}</p> : <p className="text-sm">{t('alive')}</p>}
                                        {turn === 'day' && isAlive && !isPlayerEliminated && (
                                            <button onClick={() => handleVote(pId)} className={`mt-2 btn w-full text-xs ${votes && votes[userId] === pId ? 'bg-[var(--primary)] text-white' : 'bg-gray-400'}`}>
                                                {t('vote')} {voteCount > 0 ? `(${voteCount})` : ''}
                                            </button>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="w-full max-w-4xl bg-[var(--surface-main)] p-6 rounded-2xl shadow-lg mt-6">
                        <h3 className="text-xl font-bold">{t('yourRole')}: <span className={myRole.includes('🐺') ? 'role-werewolf' : myRole.includes('👁️') ? 'role-seer' : 'role-villager'}>{myRole}</span></h3>
                        {turn === 'night' && isAlive && (
                            <NightActionPanel gameData={gameData} userId={userId} myRole={myRole} alivePlayers={alivePlayers} getGameRef={getGameRef} t={t} />
                        )}
                    </div>
                </div>
            );
        }
        
        function NightActionPanel({ gameData, userId, myRole, alivePlayers, getGameRef, t }) {
            const { players, werewolfAction, seerAction, doctorAction, roles } = gameData;

            const handleAction = (targetId) => {
                const update = {};
                if (myRole.includes('🐺')) { // Werewolf
                    update[`werewolfAction.${userId}`] = targetId;
                } else if (myRole.includes('👁️')) { // Seer
                    update.seerAction = targetId;
                } else if (myRole.includes('🧑‍⚕️')) { // Doctor
                    update.doctorAction = targetId;
                }
                updateDoc(getGameRef(gameData.roomCode), update);
            };
            
            const renderActionForRole = () => {
                switch(true) {
                    case myRole.includes('🐺'):
                        return (
                            <div>
                                <h4 className="font-bold mt-2">{t('werewolf_action')}</h4>
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {alivePlayers.filter(pId => !roles[pId].includes('🐺') && pId !== userId).map(pId => (
                                        <button key={pId} onClick={() => handleAction(pId)} className={`btn ${werewolfAction && werewolfAction[userId] === pId ? 'bg-red-600' : 'bg-gray-600'}`}>{players[pId].name}</button>
                                    ))}
                                </div>
                            </div>
                        );
                    case myRole.includes('👁️'):
                        return (
                             <div>
                                <h4 className="font-bold mt-2">{t('seer_action')}</h4>
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {alivePlayers.filter(pId => pId !== userId).map(pId => (
                                        <button key={pId} onClick={() => handleAction(pId)} className={`btn ${seerAction === pId ? 'bg-blue-600' : 'bg-gray-600'}`}>{players[pId].name}</button>
                                    ))}
                                </div>
                                {seerAction && <p className="mt-2">{t('seer_result', players[seerAction].name, roles[seerAction])}</p>}
                            </div>
                        );
                    case myRole.includes('🧑‍⚕️'):
                        return (
                            <div>
                                <h4 className="font-bold mt-2">{t('doctor_action')}</h4>
                                <div className="flex flex-wrap gap-2 mt-2">
                                    {alivePlayers.map(pId => (
                                        <button key={pId} onClick={() => handleAction(pId)} className={`btn ${doctorAction === pId ? 'bg-pink-600' : 'bg-gray-600'}`}>{players[pId].name}</button>
                                    ))}
                                </div>
                            </div>
                        );
                    default:
                        return <p className="mt-2">{t('villager_action')}</p>
                }
            };
            
            return <div className="mt-4">{renderActionForRole()}</div>;
        }


        const App = () => {
            const [gameState, setGameState] = useState('home');
            const [gameData, setGameData] = useState(null);
            const [userId, setUserId] = useState(null);
            const [username, setUsername] = useState('');
            const [error, setError] = useState('');
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [language, setLanguage] = useState('te');

            const dbRef = useRef();
            const gameUnsubscribe = useRef(null);
            
            const appId = 'werewolf-game-v1';
            const getGameRef = (code) => doc(dbRef.current, `artifacts/${appId}/public/data/games`, code);
            
            const t = useCallback((key, ...args) => {
                const value = translations[language]?.[key] || translations['en'][key];
                return typeof value === 'function' ? value(...args) : value;
            }, [language]);
            
            useEffect(() => {
                const firebaseConfig = { 
                    apiKey: "AIzaSyCp8UFvV6eOVACbaLq7ylOjEZOBitUMkfc", 
                    authDomain: "dongapolice-24f1c.firebaseapp.com", 
                    projectId: "dongapolice-24f1c", 
                };
                try {
                    const app = initializeApp(firebaseConfig);
                    dbRef.current = getFirestore(app);
                    const auth = getAuth(app);
                    signInAnonymously(auth).then(() => {
                        onAuthStateChanged(auth, user => { 
                            if (user) {
                                setUserId(user.uid); 
                                setIsFirebaseReady(true);
                            }
                        });
                    });
                } catch(e) {
                    console.error("Firebase init failed", e);
                    setError(t('error_connect_failed'));
                }
            }, [t]);

            const subscribeToGame = useCallback((code) => {
                if (gameUnsubscribe.current) gameUnsubscribe.current();
                const gameRef = getGameRef(code);
                gameUnsubscribe.current = onSnapshot(gameRef, (doc) => {
                    if (doc.exists()) {
                        setGameData(doc.data());
                        setGameState(doc.data().gameState);
                    } else {
                        setError(t('error_not_found'));
                        setGameState('home');
                        setGameData(null);
                    }
                });
            }, [t]);

            const createRoom = async () => {
                if (!username.trim()) { setError(t('error_name')); return; }
                const newRoomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
                const gameRef = getGameRef(newRoomCode);
                await setDoc(gameRef, { 
                    hostId: userId, 
                    players: { [userId]: { name: username, uid: userId } },
                    gameState: 'lobby', 
                    roomCode: newRoomCode 
                });
                subscribeToGame(newRoomCode);
            };

            const joinRoom = async (code) => {
                if (!username.trim()) { setError(t('error_name')); return; }
                if (!code) { setError(t('error_code')); return; }
                const gameRef = getGameRef(code);
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) { setError(t('error_not_found')); return; }

                await updateDoc(gameRef, { [`players.${userId}`]: { name: username, uid: userId } });
                subscribeToGame(code);
            };
            
            const renderContent = () => {
                if (!isFirebaseReady) return <div className="text-center text-lg">{t('connecting')}</div>
                
                switch (gameState) {
                    case 'lobby': return <LobbyScreen gameData={gameData} userId={userId} getGameRef={getGameRef} t={t}/>;
                    case 'night':
                    case 'day':
                        return <GameScreen gameData={gameData} userId={userId} getGameRef={getGameRef} t={t}/>;
                    default: return <HomeScreen setUsername={setUsername} createRoom={createRoom} joinRoom={joinRoom} error={error} t={t} setLanguage={setLanguage}/>;
                }
            };

            return <div className="w-screen h-screen flex justify-center items-center p-4">{renderContent()}</div>
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
�
